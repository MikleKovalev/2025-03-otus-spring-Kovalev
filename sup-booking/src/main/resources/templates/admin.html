<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ панель - Отчетность по бронированиям</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background-color: #f8f9fa;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        .main-content {
            margin-left: 280px;
            padding: 20px;
        }
        .stat-card {
            border-radius: 10px;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .table-responsive {
            max-height: 600px;
        }
        .status-confirmed {
            background-color: #d1edff;
        }
        .status-completed {
            background-color: #d4edda;
        }
        .status-cancelled {
            background-color: #f8d7da;
        }
        .status-pending {
            background-color: #fff3cd;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: static;
                height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky">
                    <div class="text-center mb-4">
                        <h4 class="text-primary">
                            <i class="bi bi-speedometer2"></i> Админ панель
                        </h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-clipboard-data"></i> Отчетность
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-calendar-check"></i> Бронирования
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-people"></i> Клиенты
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-boat"></i> Лодки
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-person-gear"></i> Инструкторы
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-4 p-3 bg-light rounded">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-person-circle fs-4 text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small class="text-muted">Администратор</small>
                                <div id="adminName">Загрузка...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-clipboard-data"></i> Отчетность по бронированиям
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-outline-secondary me-2" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> Обновить
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Всего бронирований
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBookings">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-calendar-check fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Выручка
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalRevenue">0 руб</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-currency-dollar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            Активные брони
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeBookings">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-play-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Средний чек
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="averageCheck">0 руб</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-graph-up fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">Дата с</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">Дата по</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Статус</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">Все статусы</option>
                                <option value="pending">Ожидание</option>
                                <option value="confirmed">Подтверждено</option>
                                <option value="completed">Завершено</option>
                                <option value="cancelled">Отменено</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="bi bi-funnel"></i> Применить фильтры
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bookings Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Детализация бронирований</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="bookingsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Клиент</th>
                                        <th>Телефон</th>
                                        <th>Лодка</th>
                                        <th>Инструктор</th>
                                        <th>Начало</th>
                                        <th>Окончание</th>
                                        <th>Стоимость</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTableBody">
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API endpoints
        const API_BASE_URL = 'http://localhost:8080/api';
        const BOOKINGS_ENDPOINT = `${API_BASE_URL}/admin/bookings`;
        const STATS_ENDPOINT = `${API_BASE_URL}/admin/statistics`;

        // Global variables
        let bookingsData = [];
        let currentFilters = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminProfile();
            loadStatistics();
            loadBookings();
            // setDefaultDates();
        });

        // Set default date range (last 30 days)
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
        }

        // Function to create fetch request with cookies
        function createFetchRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            return fetch(url, {
                ...defaultOptions,
                ...options
            });
        }

        // Load admin profile
        async function loadAdminProfile() {
            document.getElementById('adminName').textContent = 'Администратор';
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await createFetchRequest(STATS_ENDPOINT);
                if (response.ok) {
                    const stats = await response.json();
                    updateStatistics(stats);
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Update statistics on page
        function updateStatistics(stats) {
            document.getElementById('totalBookings').textContent = stats.totalBookings || 0;
            document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue || 0);
            document.getElementById('activeBookings').textContent = stats.activeBookings || 0;
            document.getElementById('averageCheck').textContent = formatCurrency(stats.averageCheck || 0);
        }

        // Load bookings with filters
        async function loadBookings(filters = {}) {
            showLoading(true);
            
            try {
                const queryParams = new URLSearchParams(filters).toString();
                const url = queryParams ? `${BOOKINGS_ENDPOINT}?${queryParams}` : BOOKINGS_ENDPOINT;
                
                const response = await createFetchRequest(url);
                
                if (response.ok) {
                    const data = await response.json();
                    bookingsData = data;
                    renderBookingsTable(data);
                } else {
                    throw new Error('Ошибка загрузки данных');
                }
            } catch (error) {
                console.error('Ошибка загрузки бронирований:', error);
                showError('Не удалось загрузить данные бронирований');
            } finally {
                showLoading(false);
            }
        }

        // Render bookings table
        function renderBookingsTable(bookings) {
            const tbody = document.getElementById('bookingsTableBody');
            tbody.innerHTML = '';

            if (bookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i> Нет данных для отображения
                        </td>
                    </tr>
                `;
                return;
            }

            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.className = getStatusClass(booking.status);
                
                row.innerHTML = `
                    <td>${booking.id}</td>
                    <td>${booking.clientName}</td>
                    <td>${booking.phone}</td>
                    <td>${booking.boatName || 'Не выбрана'}</td>
                    <td>${booking.instructorName || 'Без инструктора'}</td>
                    <td>${formatDateTime(booking.startTimestamp)}</td>
                    <td>${formatDateTime(booking.endTimestamp)}</td>
                    <td>${formatCurrency(booking.totalPrice)}</td>
                    <td>${getStatusBadge(booking.status)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails(${booking.id})" title="Просмотр">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="updateBookingStatus(${booking.id}, 'confirmed')" title="Подтвердить">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="updateBookingStatus(${booking.id}, 'cancelled')" title="Отменить">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Apply filters
        function applyFilters() {
            const filters = {
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value,
                status: document.getElementById('statusFilter').value
            };
            
            currentFilters = filters;
            loadBookings(filters);
        }

        // Refresh all data
        function refreshData() {
            loadStatistics();
            loadBookings(currentFilters);
        }

        // View booking details
        function viewBookingDetails(bookingId) {
            const booking = bookingsData.find(b => b.id === bookingId);
            if (booking) {
                alert(`
Детали бронирования #${booking.id}:
Клиент: ${booking.clientName}
Телефон: ${booking.phone}
Лодка: ${booking.boatName || 'Не выбрана'}
Инструктор: ${booking.instructorName || 'Без инструктора'}
Начало: ${formatDateTime(booking.startTimestamp)}
Окончание: ${formatDateTime(booking.endTimestamp)}
Стоимость: ${formatCurrency(booking.totalPrice)}
Статус: ${getStatusText(booking.status)}
                `);
            }
        }

        // Update booking status
        async function updateBookingStatus(bookingId, newStatus) {
            if (!confirm('Вы уверены, что хотите изменить статус бронирования?')) {
                return;
            }

            try {
                const response = await createFetchRequest(`${BOOKINGS_ENDPOINT}/${bookingId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    refreshData();
                    showToast('Статус бронирования обновлен', 'success');
                } else {
                    throw new Error('Ошибка обновления статуса');
                }
            } catch (error) {
                console.error('Ошибка обновления статуса:', error);
                showToast('Ошибка обновления статуса', 'error');
            }
        }

        // Utility functions
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('ru-RU');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB'
            }).format(amount);
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'Ожидание', class: 'bg-warning text-dark' },
                'confirmed': { text: 'Подтверждено', class: 'bg-primary' },
                'completed': { text: 'Завершено', class: 'bg-success' },
                'cancelled': { text: 'Отменено', class: 'bg-danger' }
            };
            
            const statusInfo = statusMap[status] || { text: status, class: 'bg-secondary' };
            return `<span class="badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ожидание',
                'confirmed': 'Подтверждено', 
                'completed': 'Завершено',
                'cancelled': 'Отменено'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'confirmed': 'status-confirmed',
                'completed': 'status-completed', 
                'cancelled': 'status-cancelled',
                'pending': 'status-pending'
            };
            return classMap[status] || '';
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const table = document.getElementById('bookingsTable');
            
            if (show) {
                spinner.classList.remove('d-none');
                table.classList.add('d-none');
            } else {
                spinner.classList.add('d-none');
                table.classList.remove('d-none');
            }
        }

        function showError(message) {
            // Simple error display - in real app you might want a better notification system
            alert('Ошибка: ' + message);
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
</html>